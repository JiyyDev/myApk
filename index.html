<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Jiyy Chat Final</title>
<style>
/* ===== GLOBAL ===== */
*{
  margin:0;
  padding:0;
  box-sizing:border-box;
  outline:none;
  -webkit-tap-highlight-color: transparent;
  user-select:none;
  -webkit-user-select:none;
  -moz-user-select:none;
  -ms-user-select:none;
  font-family:sans-serif;
}

body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: url('https://files.catbox.moe/8d7fqb.jpg') no-repeat center center fixed;
  background-size: cover;
  color: white;
  overflow-x: hidden !important;
  width: 100%;
}

/* ===== LOGIN ===== */
#loginBox {
  position:absolute;
  inset:0;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  gap:14px;
  background:#0e0f10;
}
#loginBox input {
  width:70%;
  padding:14px;
  border:none;
  border-radius:10px;
  background:#1a1c1f;
  color:white;
  text-align:center;
  font-size:16px;
}
#loginBox button {
  padding:12px 20px;
  border:none;
  border-radius:10px;
  background:#2b84ff;
  color:#fff;
  font-weight:bold;
  transition:.15s;
  cursor:pointer;
}
#loginBox button:active {
  transform:scale(.92);
}

/* ===== CHAT UI ===== */
#chatUI { display:none; }

/* ===== TOOLBAR ===== */
#toolbar {
  height:72px;
  background:#131518;
  display:flex;
  flex-direction:column;
  justify-content:center;
  padding:0 14px;
  border-bottom:1px solid #232528;
  position:relative;
}
#titleWrap {
  display:flex;
  align-items:center;
  gap:10px;
  cursor:pointer;
}
#pfp {
  width:35px;
  height:35px;
  border-radius:50%;
  object-fit:cover;
}
#toolbar span {
  font-size:17px;
  font-weight:bold;
}
#typing {
  font-size:13px;
  opacity:.6;
  margin-left:45px;
}

/* GEAR BUTTON */
#gearBtn {
  width:28px;
  height:28px;
  opacity:.85;
  transition:.15s;
  cursor:pointer;
  position:absolute;
  right:14px;
  top:22px;
}
#gearBtn:active { transform:scale(.88); opacity:1; }

/* ===== CHAT BOX ===== */
#chatBox {
  height:calc(100vh - 148px);
  overflow-y:auto;
  padding:10px 16px;
}

/* ===== BUBBLE ===== */
.bubble {
  max-width:78%;
  margin:8px 0;
  padding:12px 14px;
  border-radius:14px;
  border:1px solid #41444a;
  background:#1a1c1f;
  position:relative;
  transition: transform .18s ease;
}
.bubble.swiped { transform:translateX(40px); }
.me { margin-left:auto; border-color:#2b84ff; }
.name { font-size:13px; font-weight:bold; margin-bottom:6px; }
.time { font-size:11px; opacity:.55; margin-top:4px; text-align:right; }

/* ===== REPLY BOX ===== */
#replyBox {
  position: absolute;
  bottom: 75px;
  left: 12px;      /* jarak kiri */
  right: 12px;     /* jarak kanan */
  width: auto;     /* biar flexible */
  max-width: 95%;  /* maksimal lebar */
  background: #0b0c0d;
  border-left: 4px solid #2b84ff;
  padding: 10px 14px;
  font-size: 14px;
  display: none;
  z-index: 20;
  border-radius: 8px;
  transition: bottom .2s ease;
}

#replyUser { font-weight:bold; }
#cancelReply {
  position:absolute;
  right:10px;
  top:8px;
  cursor:pointer;
  opacity:.6;
  font-size:14px;
}

/* ===== SEND AREA ===== */
/* ===== SEND AREA ===== */
#sendArea{
  display:flex;
  gap:8px;
  padding:10px;
  position:absolute;
  bottom:12px;
  width:100%;
  background:transparent;
  z-index:15;
}
#textMsg{
  flex:1;
  padding:16px 20px;
  border-radius:28px;
  border:1px solid #3A3A3C;
  background:#1E1E1E;
  color:#E5E5EA;
  font-size:16px;
  outline:none;
  transition:all 0.2s ease-in-out;
  box-shadow:inset 0 1px 2px rgba(0,0,0,0.3);
}
#textMsg::placeholder{ color:#8E8E93; font-style:italic; }
#textMsg:focus{ border-color:#5A5A5A; box-shadow:0 0 6px rgba(255,255,255,.08); background:#242426; }

/* ===== SEND BUTTON ===== */
#sendBtn{
  width:50px;
  height:50px;
  border-radius:50%;
  background:#1E1E1E;
  border:none;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  transition:all 0.2s ease;
  color:#E5E5EA;
  font-size:18px;
}
#sendBtn.active{ background:#2B84FF; color:#fff; }
#sendBtn::before{ content:"‚úà"; display:block; }

/* ===== BLUR BACKGROUND ===== */
.blur-bg {
  position:fixed;
  inset:0;
  backdrop-filter:blur(8px);
  z-index:900;
  display:none;
}

/* ===== ADMIN PANEL ===== */
#adminPanel {
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  width:300px;
  background:#15171a;
  border:2px solid #2b84ff;
  border-radius:16px;
  padding:20px;
  display:none;
  z-index:999;
  box-shadow:0 0 20px rgba(43,132,255,.5);
}
#adminPanel h3 {
  text-align:center;
  margin-bottom:12px;
  font-size:18px;
  color:#2b84ff;
}
#adminPanel input {
  width:100%;
  margin:6px 0;
  padding:10px;
  border:none;
  border-radius:10px;
  background:#1a1c1f;
  color:#fff;
}
#adminPanel button {
  width:100%;
  margin:6px 0;
  padding:10px;
  border:none;
  border-radius:10px;
  background:#2b84ff;
  color:#fff;
  transition:.15s;
  cursor:pointer;
}
#adminPanel button:active { transform:scale(.92); }

/* ===== INFO DIALOG ===== */
#infoDialog {
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  width:280px;
  background:#15171a;
  border:2px solid #2b84ff;
  border-radius:16px;
  padding:18px;
  display:none;
  z-index:999;
  box-shadow:0 0 20px rgba(43,132,255,.5);
}
#infoDialog h3 { text-align:center; margin-bottom:10px; color:#2b84ff; }
#infoDialog p { font-size:14px; margin-bottom:6px; }
#closeInfo {
  display:block;
  margin:10px auto 0 auto;
  padding:8px 12px;
  border:none;
  border-radius:8px;
  background:#2b84ff;
  cursor:pointer;
  font-weight:bold;
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginBox">
  <h2>Jiyy Ga Project V1.0</h2>
  <input id="username" placeholder="contoh : user1, user2, ..." />
  <button id="loginBtn">LOGIN</button>
  <div style="font-size:12px;opacity:.5;">anjay login gak perlu pakek nomer cokküòè</div>
</div>

<!-- CHAT UI -->
<div id="chatUI">
  <div id="toolbar">
      <div id="titleWrap">
        <img id="pfp" src="https://files.catbox.moe/75uhd5.jpg"/>
        <span>Jiyy Chat</span>
      </div>
      <div id="typing"></div>
      <img id="gearBtn" src="https://files.catbox.moe/7ikke3.png"/>
  </div>

  <div id="chatBox"></div>

  <!-- REPLY BOX -->
  <div id="replyBox">
    <span id="replyUser"></span><br>
    <div id="replyText"></div>
    <div id="cancelReply">‚úñ</div>
  </div>

  <div id="sendArea">
    <input id="textMsg" placeholder="Tulis pesan..."/>
    <button id="sendBtn">Kirim</button>
  </div>
</div>

<!-- BLUR -->
<div class="blur-bg" id="blurBg"></div>

<!-- ADMIN PANEL -->
<div id="adminPanel">
  <h3>X ADMIN PANELS</h3>
  <input id="userInput" placeholder="user1 dst" />
  <button id="banBtn">BAN</button>
  <button id="unbanBtn">UNBAN</button>
  <button id="clearBtn">CLEAR CHAT</button>
  <button id="closePanel">CLOSE</button>
</div>

<!-- INFO DIALOG -->
<div id="infoDialog">
  <h3>INFO APLIKASI</h3>
  <p>Dibuat oleh: Mas Aji</p>
  <p>Versi: 1.0 Final</p>
  <p>Platform: Jiyy Chat HTML</p>
  <button id="closeInfo">Tutup</button>
</div>

<audio id="notifSound" src="https://files.catbox.moe/x80rgk.mp3"></audio>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { getDatabase, ref, push, remove, set, onValue, get } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBbxBR_AiOSsWdgYP0LrjvLDuyFUOJ9yH8",
  authDomain: "jiyy-chat.firebaseapp.com",
  databaseURL: "https://jiyy-chat-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "jiyy-chat",
  storageBucket: "jiyy-chat.firebasestorage.app",
  messagingSenderId: "571618866200",
  appId: "1:571618866200:web:874d128f7692c0ca82ff6d",
  measurementId: "G-SQS6KPWRKP"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let currentUser = "";
let lastMsgTime = 0;

const chatBox = document.getElementById("chatBox");
const typing = document.getElementById("typing");
const notifSound = document.getElementById("notifSound");
const adminPanel = document.getElementById("adminPanel");
const infoDialog = document.getElementById("infoDialog");
const blurBg = document.getElementById("blurBg");
let replyTo = null;

/* ===== AUTO LOGIN ===== */
let saved = localStorage.getItem("jiyy_user");
if(saved){
  currentUser = saved;
  showChat();
}

/* ===== LOGIN ===== */
document.getElementById("loginBtn").onclick = async ()=>{
  let u = document.getElementById("username").value.trim();
  if(!u) return;
  let onlineRef = ref(db,"online/"+u);
  let check = await get(onlineRef);
  if(check.exists() && u!=="jiyy-dev-pass"){ alert("Username sudah dipakai!"); return; }
  if(u === "jiyy-dev-pass"){ currentUser = "admin"; }
  else{ currentUser = u; set(ref(db,"online/"+u),true); }
  localStorage.setItem("jiyy_user", currentUser);
  showChat();
};

function showChat(){
  document.getElementById("loginBox").style.display = "none";
  document.getElementById("chatUI").style.display = "block";
  if(currentUser === "admin"){
    document.getElementById("gearBtn").onclick = ()=>{
      blurBg.style.display="block";
      adminPanel.style.display="block";
    };
  }else{ document.getElementById("gearBtn").style.display="none"; }
}

/* ===== PROFIL INFO ===== */
document.getElementById("titleWrap").onclick = ()=>{
  blurBg.style.display="block";
  infoDialog.style.display="block";
};
document.getElementById("closeInfo").onclick = ()=>{
  blurBg.style.display="none";
  infoDialog.style.display="none";
};

/* ===== LISTEN CHAT ===== */
const messagesRef = ref(db,"messages");
onValue(messagesRef,(snap)=>{
  const data = snap.val();
  chatBox.innerHTML="";
  if(!data) return;
  Object.entries(data).forEach(([id,d])=>{
    let div = document.createElement("div");
    div.className = "bubble "+(d.user===currentUser?"me":"");
    div.dataset.user = d.user;
    div.dataset.text = d.text;
    div.dataset.id = id;

    let replyHtml = "";
    if(d.reply){ replyHtml = `<div style="font-size:14px;opacity:.9;background:#0b0c0d;border-left:3px solid #2b84ff;padding:8px 10px;border-radius:8px;margin-bottom:8px;">Membalas: <b>${d.reply.user}</b><br>${d.reply.text}</div>`; }

    div.innerHTML = `<div class="name">${d.user}</div>${replyHtml}${d.text}<div class="time">${timeStr(d.time)}</div>`;

    chatBox.appendChild(div);

    let startX = 0;
    div.addEventListener("touchstart", e=>{ startX = e.touches[0].clientX; });
    div.addEventListener("touchmove", e=>{ let moveX = e.touches[0].clientX - startX; if(moveX>30) div.classList.add("swiped"); });
    div.addEventListener("touchend", ()=>{ if(div.classList.contains("swiped")){ setReply({user:div.dataset.user,text:div.dataset.text,id:div.dataset.id}); } setTimeout(()=>div.classList.remove("swiped"),150); });

    chatBox.scrollTop = chatBox.scrollHeight;

    if(d.user !== currentUser && d.time > lastMsgTime){
      notifSound.play();
      lastMsgTime = d.time;
    }
  });
});

/* ===== SET REPLY ===== */
function setReply(data){
  replyTo = data;
  document.getElementById("replyUser").textContent = data.user;
  document.getElementById("replyText").textContent = data.text;
  document.getElementById("replyBox").style.display="block";
}
document.getElementById("cancelReply").onclick = ()=>{
  replyTo=null;
  document.getElementById("replyBox").style.display="none";
};

/* ===== SEND MESSAGE ===== */
const textMsg = document.getElementById("textMsg");
const sendBtn = document.getElementById("sendBtn");

document.getElementById("sendBtn").onclick = sendMsg;
textMsg.onkeydown = e=>{ if(e.key==="Enter") sendMsg(); };

/* ===== BUTTON WARNA OTOMATIS ===== */
function updateSendBtn(){
  if(textMsg.value.trim() || replyTo){
    sendBtn.classList.add("active");
  }else{
    sendBtn.classList.remove("active");
  }
}
textMsg.addEventListener("input", updateSendBtn);

/* ===== SEND FUNCTION ===== */
async function sendMsg(){
  let t = textMsg.value.trim();
  if(!t && !replyTo) return;
  if(currentUser!=="admin"){ let banSnap = await get(ref(db,"banned/"+currentUser)); if(banSnap.exists()){ alert("Anda telah dibanned"); return; } }
  await push(messagesRef,{
    user:currentUser,
    text:t,
    time:Date.now(),
    reply: replyTo ? {user:replyTo.user,text:replyTo.text} : null
  });
  textMsg.value="";
  replyTo=null;
  document.getElementById("replyBox").style.display="none";
  updateSendBtn();
}

/* ===== TYPING ===== */
let typingRef = ref(db,"typing");
textMsg.oninput = ()=>{
  set(typingRef,currentUser);
  updateSendBtn();
  setTimeout(()=>{ set(typingRef,""); },700);
};
onValue(typingRef,(snap)=>{
  let val = snap.val();
  typing.innerHTML = val && val!==currentUser ? `${val} sedang mengetik...` : "";
});

/* ===== ADMIN PANEL ===== */
const userInput = document.getElementById("userInput");

document.getElementById("banBtn").onclick = ()=>{ let u = userInput.value.trim(); if(!u) return; set(ref(db,"banned/"+u),true); };
document.getElementById("unbanBtn").onclick = ()=>{ let u = userInput.value.trim(); if(!u) return; remove(ref(db,"banned/"+u)); };
document.getElementById("clearBtn").onclick = ()=>{ remove(messagesRef); };
document.getElementById("closePanel").onclick = ()=>{
  blurBg.style.display="none";
  adminPanel.style.display="none";
};

function timeStr(t){ let d = new Date(t); return d.getHours().toString().padStart(2,'0')+":"+d.getMinutes().toString().padStart(2,'0'); }
</script>
</body>
</html>
