<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Jiyy Chat</title>
<style>
*{
  margin:0;
  padding:0;
  box-sizing:border-box;
  outline:none;
  -webkit-tap-highlight-color: transparent;
  font-family:sans-serif;
}

body{
  background:#0e0f10;
  color:#fff;
  overflow:hidden;
}

/* LOGIN */
#loginBox{
  position:absolute;
  inset:0;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  gap:14px;
  background:#0e0f10;
}

#loginBox input{
  width:70%;
  padding:14px;
  border:none;
  border-radius:10px;
  background:#1a1c1f;
  color:white;
  text-align:center;
  font-size:16px;
}

#loginBox button{
  padding:12px 20px;
  border:none;
  border-radius:10px;
  background:#2b84ff;
  color:#fff;
  font-weight:bold;
  transition:.15s;
  cursor:pointer;
}

#loginBox button:active{
  transform:scale(.92);
}

/* CHAT UI */
#chatUI{display:none;}

/* TOP TOOLBAR */
#toolbar{
  height:52px;
  background:#131518;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 14px;
  border-bottom:1px solid #232528;
}

#toolbar span{
  font-size:17px;
  font-weight:bold;
}

#gearBtn{
  width:28px;
  height:28px;
  opacity:.85;
  transition:.15s;
  cursor:pointer;
}

#gearBtn:active{
  transform:scale(.88);
  opacity:1;
}

/* CHATBOX */
#chatBox{
  height:calc(100vh - 108px);
  overflow-y:auto;
  padding:10px 16px;
}

/* BUBBLE */
.bubble{
  max-width:78%;
  margin:8px 0;
  padding:10px 12px;
  border-radius:12px;
  border:1px solid #41444a;
  background:#1a1c1f;
  position:relative;
}

.me{
  margin-left:auto;
  border-color:#2b84ff;
}

/* NAME */
.name{
  font-size:13px;
  font-weight:bold;
  margin-bottom:4px;
}

/* TIME RIGHT BOTTOM */
.time{
  font-size:11px;
  opacity:.55;
  margin-top:4px;
  text-align:right;
}

/* SEND AREA */
#sendArea{
  height:56px;
  display:flex;
  gap:7px;
  padding:10px;
  background:#131518;
  border-top:1px solid #232528;
}

#textMsg{
  flex:1;
  padding:10px;
  background:#1a1c1f;
  border:none;
  border-radius:10px;
  color:white;
}

#sendBtn{
  padding:10px 18px;
  border:none;
  border-radius:10px;
  background:#2b84ff;
  color:#fff;
  transition:.15s;
  cursor:pointer;
}

#sendBtn:active{
  transform:scale(.92);
}

/* ADMIN PANEL */
#adminPanel{
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  width:260px;
  background:#15171a;
  border:1px solid #232528;
  border-radius:12px;
  padding:18px;
  display:none;
  z-index:999;
}

#adminPanel h3{
  text-align:center;
  margin-bottom:10px;
}

#adminPanel input{
  width:100%;
  margin:6px 0;
  padding:10px;
  border:none;
  border-radius:8px;
  background:#1a1c1f;
  color:#fff;
}

#adminPanel button{
  width:100%;
  margin:6px 0;
  padding:10px;
  border:none;
  border-radius:8px;
  background:#2b84ff;
  color:#fff;
  transition:.15s;
  cursor:pointer;
}

#adminPanel button:active{
  transform:scale(.92);
}

/* TYPING */
#typing{
  font-size:13px;
  opacity:.6;
  padding:4px 16px;
}

/* TOAST */
#toast{
  position:fixed;
  bottom:80px;
  left:50%;
  transform:translateX(-50%);
  background:rgba(37,99,235,.9);
  color:#fff;
  padding:8px 16px;
  border-radius:999px;
  font-size:13px;
  opacity:0;
  transition:.3s;
  z-index:9999;
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginBox">
  <h2>Jiyy Chat</h2>
  <input id="username" placeholder="user1, user2, ..." />
  <button id="loginBtn">LOGIN</button>
  <div style="font-size:12px;opacity:.5;">Login sekali, auto masuk</div>
</div>

<!-- CHAT UI -->
<div id="chatUI">
  <div id="toolbar">
    <span>Jiyy Chat</span>
    <img id="gearBtn" src="gear.png"/>
  </div>

  <div id="chatBox"></div>
  <div id="typing"></div>

  <div id="sendArea">
    <input id="textMsg" placeholder="Tulis pesan..."/>
    <button id="sendBtn">Kirim</button>
  </div>
</div>

<!-- ADMIN PANEL -->
<div id="adminPanel">
  <h3>ADMIN PANEL</h3>
  <input id="userInput" placeholder="user1 dst" />
  <button id="banBtn">BAN</button>
  <button id="unbanBtn">UNBAN</button>
  <button id="clearBtn">CLEAR CHAT</button>
  <button id="closePanel">CLOSE</button>
</div>

<div id="toast"></div>

<audio id="notifSound" src="notif.mp3"></audio>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { getDatabase, ref, push, remove, set, onChildAdded, onValue, get } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBbxBR_AiOSsWdgYP0LrjvLDuyFUOJ9yH8",
  authDomain: "jiyy-chat.firebaseapp.com",
  databaseURL: "https://jiyy-chat-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "jiyy-chat",
  storageBucket: "jiyy-chat.firebasestorage.app",
  messagingSenderId: "571618866200",
  appId: "1:571618866200:web:874d128f7692c0ca82ff6d",
  measurementId: "G-SQS6KPWRKP"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let currentUser = "";
const chatBox = document.getElementById("chatBox");
const typing = document.getElementById("typing");
const notifSound = document.getElementById("notifSound");
const toast = document.getElementById("toast");
const adminPanel = document.getElementById("adminPanel");

/* AUTO LOGIN */
let saved = localStorage.getItem("jiyy_user");
if(saved){
  currentUser = saved;
  showChat();
}

/* LOGIN */
document.getElementById("loginBtn").onclick = async ()=>{
  let u = document.getElementById("username").value.trim();
  if(!u) return;

  let onlineRef = ref(db,"online/"+u);
  let check = await get(onlineRef);
  if(check.exists() && u!=="jiyy-dev-pass"){
    alert("Username sudah dipakai!");
    return;
  }

  if(u === "jiyy-dev-pass"){
    currentUser = "admin";
  }else{
    currentUser = u;
    set(ref(db,"online/"+u),true);
  }

  localStorage.setItem("jiyy_user", currentUser);
  showChat();
};

function showChat(){
  document.getElementById("loginBox").style.display = "none";
  document.getElementById("chatUI").style.display = "block";

  if(currentUser === "admin"){
    document.getElementById("gearBtn").onclick = ()=>{
      adminPanel.style.display = "block";
    };
  }else{
    document.getElementById("gearBtn").style.display = "none";
  }
}

/* LISTEN CHAT */
const messagesRef = ref(db,"messages");
onValue(messagesRef,(snap)=>{
  chatBox.innerHTML="";
  const data = snap.val();
  if(!data) return;
  Object.values(data).forEach(d=>{
    let div = document.createElement("div");
    div.className = "bubble "+(d.user===currentUser?"me":"");
    div.innerHTML = `<div class="name">${d.user}</div>${d.text}<div class="time">${timeStr(d.time)}</div>`;
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
  });
});

/* SEND */
const textMsg = document.getElementById("textMsg");
document.getElementById("sendBtn").onclick = sendMsg;
textMsg.onkeydown = e=>{ if(e.key==="Enter") sendMsg(); };

async function sendMsg(){
  let t = textMsg.value.trim();
  if(!t) return;

  // cek banned
  if(currentUser!=="admin"){
    let banSnap = await get(ref(db,"banned/"+currentUser));
    if(banSnap.exists()){
      alert("Anda telah dibanned oleh admin");
      return;
    }
  }

  push(messagesRef,{
    user:currentUser,
    text:t,
    time:Date.now()
  });
  textMsg.value="";
  notifSound.play();
}

/* TYPING */
let typingRef = ref(db,"typing");
textMsg.oninput = ()=>{
  set(typingRef,currentUser);
  setTimeout(()=>{ set(typingRef,""); },700);
};
onValue(typingRef,(snap)=>{
  let val = snap.val();
  typing.innerHTML = val && val!==currentUser ? `${val} sedang mengetik...` : "";
});

/* ADMIN */
const userInput = document.getElementById("userInput");
function showToast(msg){
  toast.textContent = msg;
  toast.style.opacity=1;
  setTimeout(()=>{ toast.style.opacity=0; },1800);
}

document.getElementById("banBtn").onclick = ()=>{
  let u = userInput.value.trim();
  if(!u) return;
  set(ref(db,"banned/"+u),true);
  showToast(u+" berhasil di BAN");
};

document.getElementById("unbanBtn").onclick = ()=>{
  let u = userInput.value.trim();
  if(!u) return;
  remove(ref(db,"banned/"+u));
  showToast(u+" berhasil di UNBAN");
};

document.getElementById("clearBtn").onclick = ()=>{
  remove(messagesRef);
  showToast("Chat telah di CLEAR untuk semua user");
};

document.getElementById("closePanel").onclick = ()=>{
  adminPanel.style.display="none";
};

function timeStr(t){
  let d = new Date(t);
  return d.getHours().toString().padStart(2,'0')+":"+d.getMinutes().toString().padStart(2,'0');
}
</script>
</body>
</html>